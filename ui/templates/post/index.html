{% extends "../base.html" %}

{% block title %}Posts{% end %}

{% block javascript %}
    <script type="text/javascript">
       function adjust_post() {
         $('.post').each(function(i, o) {
             var h = $(this).height();
             h = h / 2 - 38;
             $(this).closest('.post').children('.avatar').css({'margin-top': h});

             if($(this).height() == 100) {
              $(this).closest('.post').children('.info').css({'margin-top': 22});
             }
         });
       };

       function fix_scrolling_streams() {
         // Fix featured and non-featured post stream
          var top_height = $('#navigation_bar').height() + $('#featured_posts_bar').height() + 25;
          $('#featured_post_stream').height($(window).innerHeight() - top_height);
          $('#post_stream').height($(window).innerHeight() - top_height);
       }

      $(window).resize(function() { 
          adjust_post();
          fix_scrolling_streams();
      });

      $(function() {
          // Fix featured post borders
          $('.post.featured').prev().css({'border-bottom': 'none'});
          // Fix left featured post stream height
          fix_scrolling_streams();
          // Fix mobile Safari quirks
          $('#myimage').click(function() { return false; });
          $('#myimage').off('click');

          // Hide iPhone URL bar
          window.scrollTo(0, 1);

          // Fixup avatars and title
          adjust_post();
       });
    </script>
{% end %}

{% block content %}
    <div id="featured_posts">
          <div id="featured_posts_bar" class="column_header">
            <p>Featured Posts</p>
          </div>

          <div id="featured_post_stream">
                {% for post in featured_posts %}
                    <div class="post featured">
                        <div class="info">
                            <a href="/posts/{{ post.slug }}" class="title" target="_blank">
                                <p>
                                    {{ post.title }}
                                </p>
                            </a>
                            <div class="content">
                            {% raw post.body_truncated %}
                            </div>
                            <a href="/posts/{{ post.slug }}" class="continue_button" target="_blank">Continue</a>
                            <div class="featured_info">
                                <a href="http://twitter.com/{{ post.user.username }}" class="user" target="_blank">{{ post.user.username }}</a>
                                <p class="featured_info_divider">/</p>
                                <a href="/posts/{{ post.slug }}" class="date" target="_blank">{{ post.date_created.strftime("%d %b %Y") }}</a>
                                <p class="featured_info_divider">/</p>
                                <span class="replies">
                                  <i class="icon-comment icon"></i>&nbsp;
                                  <a href="/posts/{{ post.slug
                                      }}#disqus_thread" class="sub-comments" target="_blank">0 comments</a>
                                </span>
                            </div>
                        </div>
                    </div>
                {% end %}
                {% if featured_posts %}
                    <a href="/featured_posts" class="column_link">More &raquo;</a>
                {% end %}
          </div>
    </div>

    <div id="post_column">
        <div id="post_stream_bar" class="column_header">
          <p>Posts Stream</p>
          <a href="?sort_by=hot" class="{{ 'selected' if sort_by == 'hot' else '' }}">hot</a>
          <a href="?sort_by=new" class="{{ 'selected' if sort_by == 'new' else '' }}">new</a>
        </div>

        <div id="post_stream">
            <div id="pinned_featured_posts">
            {% for post in featured_posts[:3] %}
                <div class="post featured">
                    <img src="{{ twitter_avatar_size(post.user.profile_image_url_https, 'bigger') }}" class="img-circle avatar" alt="avatar" />
                    <div class="info">
                        <a href="{{ "/posts/%s" % (post.slug) }}" class="title" target="_blank">
                            <p>
                                {{ post.title }}
                            </p>
                        </a>
                        <a href="{{ "/posts/%s" % (post.slug) }}" class="site" target="_blank">usv.com</a>
                        <br/>
                        <a href="http://twitter.com/{{ post.user.username }}" class="user" target="_blank"><i class="icon-twitter icon"></i>@{{ post.user.username }}</a>
                        <span class="comments">
                          <i class="icon-comment icon"></i>
                          <a href="/posts/{{ post.slug }}#disqus_thread" class="sub-comments" target="_blank">0 comments</a>
                        </span>
                    </div>
                </div>
              {% end %}
              {% if featured_posts %}
                  <a href="/featured_posts" class="column_link">more featured posts &nbsp;&raquo;</a>
              {% end %}
              </div>

            {% if count == 0 and rstart != 0 %}
                <a href="/?sort_by={{ sort_by }}" class="new_posts_link">New posts ({{ rstart }})</a>
            {% end %}

            {% for post in posts %}
                <div class="post">
                    <img src="{{ twitter_avatar_size(post.user.profile_image_url_https, 'bigger') }}" class="img-circle avatar" alt="avatar" />
                    <div class="info">
                        {% if post.url %}
                            <a href="{{ post.url }}" class="title" target="_blank">
                                <p>
                                    {{ post.title }}
                                </p>
                            </a>
                            <a href="{{ post.url }}" class="site" target="_blank">{{ urlparse(post.url).netloc }}</a>
                        {% else %}
                            <a href="{{ "/posts/%s" % (post.slug) }}" class="title" target="_blank">
                                <p>
                                    {{ post.title }}
                                </p>
                            </a>
                            <a href=""{{ "/posts/%s" % (post.slug) }} class="site" target="_blank">usv.com</a>
                        {% end %}
                        <br/>
                        <a href="http://twitter.com/{{ post.user.username }}" class="user" target="_blank"><i class="icon-twitter icon"></i>@{{ post.user.username }}</a>
                        <span class="comments">
                          <i class="icon-comment icon"></i>
                          <a href="/posts/{{ post.slug }}#disqus_thread" class="sub-comments" target="_blank">0 comments</a>
                        </span>
                        <a href="/posts/{{ post.slug }}" class="date" target="_blank"><i class="icon-calendar icon"></i>{{ post.date_created.strftime("%B %d, %Y") }}</a>
                        {% module ajax_upvote_link(post=post) %}
                        {% if is_admin() %}
                          <a href="/posts/{{ post.slug }}/feature" class="feature"><i class="icon-star icon"></i>Feature</a>
                        {% end %}
                    </div>
                </div>
                {% end %}
                <div style="float: right;">
                    {% if rend < num_posts - 1 %}
                        <a href="?sort_by={{sort_by }}&anchor={{ posts[-1].id }}&action=after&count={{ count + per_page }}" class="column_link">Next</a>
                    {% end %}
                    {% if rstart > 0 %}
                        <a href="?sort_by={{ sort_by }}&anchor={{ posts[0].id }}&action=before&count={{ count - per_page }}" class="column_link">Prev</a>
                    {% end %}
                </div>
        </div>
    </div>

    {% module disqus_count_js() %}
{% end %}
