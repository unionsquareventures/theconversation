{% extends '../base.html' %}
{% block body_class %}conversation{% end %}

{% block javascript %}
  <script>
  $(document).ready(function() {
    $('#bookmarklet').click(function(e) {
      e.preventDefault();
      alert('This is bookmarklet.  First drag it to your bookmarks bar, then you can use it to share web pages to USV.com.');
    })

    // Truncate featured post text
    $('.excerpt').text(function(e) {
      var text = $(this).text();
      if (text.match(/\.{3}/)) {
        var i = text.lastIndexOf(' ');
        if (i != -1) {
          text = text.substr(0,i) + "..."
        }
      }
      return text;
  });
  
    fp_max_height = 0;
    $('.featured-post').each(function() {
      if ($(this).height() > fp_max_height) {
        fp_max_height = $(this).height();
      }
    })
    
    if ($('.featured-post:visible').length == 2) {
      /* only do this on ipad where we're showing two at the top */
      $('.featured-post').height(fp_max_height);
    }

    //AJAX request to get user status
    $.get('/api/user_status/', function (user_status) {
      if (user_status == 'staff'){
        $('#submit-modal .submit').show();
        $('#submit-modal .login').hide();
        $('#submit-modal .submit-staff').show();
      }
      else if (user_status == 'user') {
        $('#submit-modal .submit').show();
        $('#submit-modal .login').hide();
      }
      // blacklist is currently being handled outside the modal
      // defaults to user not logged in, no need to do anything in this case
    });  
    
    $('a.mute').click(function(e) {
      e.preventDefault();
      if (confirm("are you sure?")) {
        window.location = this.href;
      }
      
    })
    
    
    /* DISQUS */
  
    var disqusPublicKey = "{{ settings.disqus_public_key }}";
    var disqusShortname = "usvbeta2"; // Replace with your own shortname
  
    var urlArray = [];
    
    $('.comment-count').each(function () {
      var url = $(this).attr('data-disqus-url');
      urlArray.push('link:' + url);
      
      $.ajax({
        type: 'GET',
        url: "https://disqus.com/api/3.0/threads/set.jsonp",
        data: { api_key: disqusPublicKey, forum : disqusShortname, thread : urlArray },
        cache: false,
        dataType: 'jsonp',
        success: function (result) {
      
          /*for (var i in result.response) {
      
            var countText = " comments";
            var count = result.response[i].posts;
      
            if (count == 1)
              countText = " comment";
      
            $('div[data-disqus-url="' + result.response[i].link + '"]').html('<h4>' + count + countText + '</h4>');
      
          }
          */
          console.log(result.response);
        }
      });
    });
      
      
}); 
  </script>
{% end %}

{% block precontent %}
    <div class="tools tools-mobile visible-xs"><b>Welcome!</b> &nbsp; <a href="/posts/welcome-to-the-new-usvcom#comment-1066691905">Posting guidelines</a> | <a href="https://play.google.com/store/apps/details?id=com.connectedio.usvmobile" target="_blank">Android app</a> </div>
{% end %}


{% block content %}

<div id="main" role="main">
    <section class="featured-feed clearfix{{ ' mobile-hidden' if (rstart > 0) or sort_by_specified else '' }}">
        <!--<ul class="tabs">
            <li><a class="current" href="/featured_posts">Featured</a></li>
        </ul>-->
        
        <div id='slider' class='swipe visible-xs row'>
          <ul class='swipe-wrap feed'>
            {% for i, post in enumerate(sticky) %}
            <div class="featured-post">
            <div class="content">
                  <a class="title" href="/posts/{{ post.slug }}">{{ post.title }}</a>
              {% if post.url %}
                  <a href="{{ post.url }}" class="source" target="_blank">{{ urlparse(post.url).netloc }}</a>
              {% else %}
                  <a href="/posts/{{ post.slug }}" class="source">usv.com</a>
              {% end %}
              <div class="excerpt">{{ post.body_truncated }}</div>
              <div class="meta">
                  <div class="thumbnail">
                    <a href="http://www.twitter.com/{{ post.user.username }}" target="_blank">
                      <img title="{{ post.user.username }}" src="{{ twitter_avatar_size(post.user.profile_image_url_https, 'normal') }}" alt="thumbnail">
                    </a>
                  </div>
                  @{{ post.user.username }}
                  <span class="time">{{ pretty_date(post.date_created) }}</span>
                  {% module ajax_upvote_link(post=post) %}
                  <a class="comment-count" href="/posts/{{ post.slug }}" data-disqus-url="{{ post.permalink() }}"
                      data-disqus-identifier="{{ post.id }}" target="_blank">comment</a>
              </div>
            </div>
            </div>
            {% end %}
            {% for i, post in enumerate(featured_posts) %}
            <div class="featured-post">
            <div class="content">
                  <a class="title" href="/posts/{{ post.slug }}">{{ post.title }}</a>
              {% if post.url %}
                  <a href="{{ post.url }}" class="source" target="_blank">{{ urlparse(post.url).netloc }}</a>
              {% else %}
                  <a href="/posts/{{ post.slug }}" class="source">usv.com</a>
              {% end %}
              <div class="excerpt">{{ post.body_truncated }}</div>
              <div class="meta">
                  <div class="thumbnail">
                    <a href="http://www.twitter.com/{{ post.user.username }}" target="_blank">
                      <img title="{{ post.user.username }}" src="{{ twitter_avatar_size(post.user.profile_image_url_https, 'normal') }}" alt="thumbnail">
                    </a>
                  </div>
                  @{{ post.user.username }}asfdsf
                  <span class="time">{{ pretty_date(post.date_created) }}</span>
                  {% module ajax_upvote_link(post=post) %}
                  <a class="comment-count" href="/posts/{{ post.slug }}" data-disqus-url="{{ post.permalink() }}"
                      data-disqus-identifier="{{ post.id }}" target="_blank">comment</a>
              </div>
            </div>
            </div>
            {% end %}
          </ul>
        </div>
        
        <ul class="feed hidden-xs" id="homepage-featured-posts">
          {% for post in sticky %}
            {% module featured_post(post=post, urlparse=urlparse, show_votes=True, show_source=True) %}
          {% end %}
          
          {% for post in featured_posts %}
            {% module featured_post(post=post, urlparse=urlparse, show_votes=True, show_source=True) %}
          {% end %}
        </ul><!--end of feed-->
        <a class="more-link" href="/featured_posts">Featured Posts</a>
    </section><!--end of featured-feed-->

    <section class="hot-newest-feed">
      <ul class="tabs">
          <li class="{{ 'is-active' if sort_by == 'hot' else '' }}"><a class="sort btn" href="?sort_by=hot">Hot</a></li>
          <li class="{{ 'is-active' if sort_by == 'new' else '' }}"><a class="sort btn" href="?sort_by=new">Newest</a></li>
          {% if not is_blacklisted %}
          <li class="submit-btn">
            <a class="btn btn-primary" role="button" data-toggle="modal" href="#submit-modal">Submit a post</a>     
          </li>
          {% end %}
        </ul>

        <ul class="tools hidden-xs" id="tools-desktop">
          <li><a href="/posts/welcome-to-the-new-usvcom#comment-1066691905">Guidelines</a></li>
          <li><a data-toggle="modal" href="#tools">Tools</a></li>
          <li><a href="/feed" onclick="(function(){var z=document.createElement('script');z.src='https://www.subtome.com/load.js';document.body.appendChild(z);})(); return false">Feed</a></li>
        </ul>

        <!-- Tools Modal -->
        <div class="modal fade" id="tools" tabindex="-1" role="dialog" aria-labelledby="toolsLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Posting Tools for USV.com</h4>
              </div>
              <div class="modal-body">
                <p>Use these tools to make it easier to share links to USV.com:</p>
                <ul>
                  <li><b><a href="https://chrome.google.com/webstore/detail/usvcom/ikpfoekojmeibidkolkbbocepjfdmgol">Chrome Extension</a></b><br /> Quickly post whatever page you're viewing to USV.com</li>
                  <li><b>Bookmarklet:</b> <a id="bookmarklet" href="javascript:var d%3Ddocument,w%3Dwindow,e%3Dw.getSelection,k%3Dd.getSelection,x%3Dd.selection,s%3D(e%3Fe():(k)%3Fk():(x%3Fx.createRange().text:0)),f%3D%27http://beta.usv.com/posts/new%27,l%3Dd.location,e%3DencodeURIComponent,p%3D%27%3Fv%3D3%26url%3D%27%2Be(l.href) %2B%27%26title%3D%27%2Be(d.title) %2B%27%26s%3D%27%2Be(s),u%3Df%2Bp%3Btry%7Bif(!/%5E(.*%5C.)%3Ftumblr%5B%5E.%5D*%24/.test(l.host))throw(0)%3Btstbklt()%3B%7Dcatch(z)%7Ba %3Dfunction()%7Bif(!w.open(u,%27t%27,%27toolbar%3D0,resizable%3D0,status%3D1,width%3D450,height%3D430%27))l.href%3Du%3B%7D%3Bif(/Firefox/.test(navigator.userAgent))setTimeout(a,0)%3Belse a()%3B%7Dvoid(0)">Post to USV.com</a> (&larr; drag to your bookmarks bar)<br />Works on any browser.</li>
                  <li><b><a href="https://play.google.com/store/apps/details?id=com.connectedio.usvmobile">Android App</a></b><br /> Quickly post a link to USV.com, from your Android device.</li>
                  
                </ul>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->


        <ul class="feed sort-by-{{ sort_by }}">
            {% if count == 0 and rstart != 0 %}
              <li class="new_posts_notification">
                <a href="/?sort_by={{ sort_by }}" class="new_posts_link">New posts ({{ rstart }})</a>
              </li>
            {% end %}

            {% for post in posts %}
              {% if 'previous_author_username' in locals() and previous_author_username == post.user.username %}
                {% set repeat = True %}
              {% else %}
                {% set repeat = False %}
              {% end %}
            {% if sort_by == "hot" and post.muted %}
            
            {% else %}
            <li {% if repeat %}class="repeat"{% end %}>
              <div class="avatar">
                <a href="http://www.twitter.com/{{ post.user.username }}" target="_blank">
                <img title="{{ post.user.username }}" src="{{ twitter_avatar_size(post.user.profile_image_url_https, 'normal') }}" alt="thumbnail">
                </a>
              </div>
              <div class="content">
                
            
                {% if post.url %}
                    <a class="title" href="{{ post.url }}" rel="nofollow" target="_blank">{{ post.title }}</a>
                    <a href="{{ post.url }}" rel="nofollow" class="source" target="_blank">{{ urlparse(post.url).netloc }}</a>
                {% else %}
                    <a class="title" href="/posts/{{ post.slug }}" target="_blank">{{ post.title }}</a>
                    <a href="/posts/{{ post.slug }}" class="source" target="_blank">usv.com</a>
                {% end %}
            
                <div class="meta">
                  <a class="username-link" href="http://www.twitter.com/{{ post.user.username }}" target="_blank" style="color: #999">@{{ post.user.username }}</a>
                  <span class="username" style="">@{{ post.user.username }}</span>
                  
                  {% module ajax_upvote_link(post=post) %}                
                  <span class="time"><a href="/posts/{{ post.slug }}" ><span class="glyphicon glyphicon-link" style="margin: 0;font-size: 90%"></span> {{ pretty_date(post.date_created) }}</a></span>
                  <a href="/posts/{{ post.slug }}" ><span class="glyphicon glyphicon-comment" style="margin: 0;font-size: 90%"></span></a> <a class="comment-count" href="/posts/{{ post.slug }}" data-disqus-url="{{ post.permalink() }}" data-disqus-identifier="{{ post.id }}">comment</a>
                
                {% if is_staff(username) %}
                &nbsp;&nbsp;
                <span class="volume">
                  {% if not post.muted %}
                  <a title="mute (remove from front page)" style="color: #333; opacity:.5; font-size: 1.2em" href="/posts/{{ post.slug }}/mute" class="mute"><span class="glyphicon glyphicon-volume-off"></span></a>
                  <a title="make this quieter" style="color: red; opacity:.5; font-size: 1.2em" href="/posts/{{ post.slug }}/bumpdown"><span class="glyphicon glyphicon-volume-down"></span></a>
                  <a title="make this louder" style="color: blue;  opacity:.5; font-size: 1.1em;" href="/posts/{{ post.slug }}/bumpup"><span class="glyphicon glyphicon-volume-up"></span></a>
                
                 {% else %}
                <a title="unmute this post" style="color: blue;  opacity:.5; font-size: 1.1em;" href="/posts/{{ post.slug }}/unmute"><span class="glyphicon glyphicon-volume-off"></span></a>
                {% end %}
              </span><!-- volume -->
                {% end %}
                </div>
              </div>
              </li>      
              {% set previous_author_username = post.user.username %}       
            {% end %}
            {% end %}
        </ul><!--end of feed-->

        <div id="pagination-next-prev">
          {% if rstart > 0 %}
              <a class="prev-page" href="?sort_by={{ sort_by }}&anchor={{ posts[0].id }}&action=before&count={{ count - per_page }}">Prev</a>
          {% end %}
          {% if rend < num_posts - 1 %}
              <a class="next-page" href="?sort_by={{sort_by }}&anchor={{ posts[-1].id }}&action=after&count={{ count + per_page }}">Next</a>
          {% end %}
        </div>
    </section>
  </div><!--end of main-->
  
  {% module disqus_count_js() %}
{% end %}
