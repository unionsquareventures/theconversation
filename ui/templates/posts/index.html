{% extends "../base.html" %}

{% block title %}Posts{% end %}

{% block javascript %}
    <script type="text/javascript">
       function adjust_post() {
         $('.post').each(function(i, o) {
             var h = $(this).height();
             console.log(h);
             h = h / 2 - 38;
             $(this).closest('.post').children('.avatar').css({'margin-top': h});

             if($(this).height() == 100) {
              $(this).closest('.post').children('.info').css({'margin-top': 22});
             }
         });
       };

       function fix_scrolling_streams() {
         // Fix featured and non-featured post stream
          var top_height = $('#navigation_bar').height() + $('#featured_posts_bar').height() + 25;
          $('#featured_post_stream').height($(window).innerHeight() - top_height);
          $('#post_stream').height($(window).innerHeight() - top_height);
       }

      $(window).resize(function() { 
          adjust_post();
          fix_scrolling_streams();
      });

      $(function() {
          // Fix featured post borders
          $('.post.featured').prev().css({'border-bottom': 'none'});
          // Fix left featured post stream height
          fix_scrolling_streams();
          // Fix mobile Safari quirks
          $('#myimage').click(function() { return false; });
          $('#myimage').off('click');
          $("#navigation_button").tappable(function() {
            $("#navigation_button").toggleClass("active");
            $("#navigation_items").collapse('toggle');
           });

          // Hide iPhone URL bar
          window.scrollTo(0, 1);

          // Fixup avatars and title
          adjust_post();
       });
    </script>
{% end %}

{% block content %}
    <div id="featured_posts">
          <div id="featured_posts_bar" class="column_header">
            <p>Feautured Posts</p>
          </div>

          <div id="featured_post_stream">
                {% for post in featured_posts %}
                    {% set path = '%ss' % post._class_name.split('.')[1].lower() %}

                    <div class="post featured">
                        <div class="info">
                            <a href="/{{ path }}/{{ post.id }}" class="title" target="_blank">
                                <p>
                                    {{ post.title }}
                                </p>
                            </a>
                            <div class="content">
                            {% raw post.body_html %}
                            </div>
                            <a href="/{{ path }}/{{ post.id }}" class="continue_button" target="_blank">Continue</a>
                            <div class="featured_info">
                                <a href="http://twitter.com/{{ post.user.username }}" class="user" target="_blank">{{ post.user.username }}</a>
                                <p class="featured_info_divider">/</p>
                                <a href="/{{ path }}/{{ post.id }}" class="date" target="_blank">{{ post.date_created.strftime("%d %b %Y") }}</a>
                                <p class="featured_info_divider">/</p>
                                <span class="replies">
                                  <i class="icon-comment icon"></i>&nbsp;
                                  <a href="/{{ path }}/{{ post.id }}#disqus_thread" class="sub-comments" target="_blank">0</a>
                                </span>
                            </div>
                        </div>
                    </div>
                {% end %}
          </div>
    </div>

    <div id="post_column">
        <div id="post_stream_bar" class="column_header">
          <p>Posts Stream</p>
          <a href="?sort_by=hot" class="{{ 'selected' if sort_by == 'hot' else '' }}">hot</a>
          <a href="?sort_by=new" class="{{ 'selected' if sort_by == 'new' else '' }}">new</a>
        </div>

        <div id="post_stream">
            {% for post in posts %}
                {% set path = '%ss' % post._class_name.split('.')[1].lower() %}

                <div class="post">
                    <img src="http://api.twitter.com/1/users/profile_image?screen_name={{ post.user.username }}&size=original" class="img-circle avatar" alt="avatar" />
                    <div class="info">
                        <a href="{{ post.url or "/%s/%s" % (path, post.id) }}" class="title" target="_blank">
                            <p>
                                {{ post.title }}
                            </p>
                        </a>
                        {% if post.url %}
                            <a href="{{ post.url }}" class="site" target="_blank">{{ urlparse(post.url).netloc }}</a>
                        {% else %}
                            <a href="{{ "/%s/%s" % (path, post.id) }}" class="site" target="_blank">usv.com</a>
                        {% end %}
                        <br/>
                        <a href="http://twitter.com/{{ post.user.username }}" class="user" target="_blank"><i class="icon-twitter icon"></i>@{{ post.user.username }}</a>
                        <span class="comments">
                          <i class="icon-comment icon"></i>
                          <a href="/{{ path }}/{{ post.id }}#disqus_thread" class="sub-comments" target="_blank">0</a>
                          <a href="/{{ path }}/{{ post.id }}" class="sub-comments" target="_blank">comments</a>
                        </span>
                        <a href="/{{ path }}/{{ post.id }}" class="votes" target="_blank"><i class="icon-arrow-up icon"></i>{{ post.votes }} votes</a>
                    </div>
                </div>
            {% end %}
        </div>
    </div>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'usvgamma'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
{% end %}
